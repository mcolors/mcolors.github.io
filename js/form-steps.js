$(function(){
    function validate(e,s,t){t=t||!1;
    var r={EMPTY_FIELD:"Заполните поле",
        WRONG_EMAIL:"Некорректный E-mail",
        WRONG_SITE:"Некорректный адрес сайта",
        WRONG_PHONE:"Некорректный номер телефона",
        TOO_SHORT_PHONE:"Слишком короткий номер телефона"},a=null,o={valid:!0,message:"",empty:!1
    };
    switch(e=$.trim(e),s){
        case"phone":a=/^[\+\-\d\s\(\)]+$/i,o.message=r.WRONG_PHONE;
        break;
        case"email":a=/.+@.+\..+/i,o.message=r.WRONG_EMAIL;
        break;
        case"site":a=/.+\..{2,}/i,o.message=r.WRONG_SITE;
        break;
        default:a=/.+/,o.message=r.EMPTY_FIELD}
            if("phone"===s){
                var n=e.match(/\d/g);(!n||n.length<7)&&(o.valid=!1,o.message=r.TOO_SHORT_PHONE)}
                return o.empty=0==e.length,o.empty?t?(o.valid=!0,o):(o.valid=!1,o.message=r.EMPTY_FIELD,o):(o.valid=a.test(e),o)}function showOverlay(){$overlay=$(".formsteps__overlay"),$(".formsteps__controls").hide(),$(".formsteps__btn--submit").show(),$overlay.show(0,function(){$overlay.removeClass("formsteps__overlay--hidden")}),animateToCount($(".formsteps__overlay-percent span"),100,3100,500,function(){}),setTimeout(function(){$overlay.addClass("formsteps__overlay--rotate"),setTimeout(function(){$(".formsteps__overlay-percent span").text("Готово!").parent().addClass("formsteps__overlay-percent--ready"),$overlay.addClass("formsteps__overlay--aside")},2e3)},3500)}function stepTo(e){var s=$(".formsteps__step");s.removeClass("formsteps__step--current").eq(e).addClass("formsteps__step--current"),$(".formsteps__progress-item").removeClass("formsteps__progress-item--current").eq(e).addClass("formsteps__progress-item--current");var t=$(".formsteps__progress-line"),r=e*(100/(s.length-1));$(".js-formsteps__current").text(e+1),t.css("background-position-y",r+"%")}function animateToCount(e,s,t,r,a){var o=r||0;e.prop("Counter",0).delay(o).animate({Counter:s||100},{duration:t||4e3,easing:"swing",step:function(e){$(this).text(Math.ceil(e))},complete:function(){a()}})}$(document).on("click",".js-formsteps",function(e){e.preventDefault(),$(".formsteps-popup").removeClass("formsteps-popup--hidden").fadeIn(300).data("trigger",this)}),$(".js-formsteps__total").text($(".formsteps__step").length);var $btns=$(".js-formsteps-btn");$('input[data-type="phone"]').inputmask("+7 (999) 999-99-99",{placeholder:"*"});var $popup=$(".formsteps-popup"),ga_group=$popup.data("ga_group"),ga_postfix=$popup.data("ga_step_postfix"),ga_step,iOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;window.ontouchstart||navigator.MaxTouchPoints||navigator.msMaxTouchPoints||iOS||$("body").addClass("notouch"),$(document).on("click",".js-formsteps-btn",function(e){e.preventDefault();var s=$(this),t=$(".formsteps__step--current"),r=!0;if(!s.hasClass("formsteps__btn--disabled")){if(s.is(":last-child")){if(t.find(".js-required").each(function(){var e=$(this).find("input"),s=validate(e.val(),e.data("type"),e.data("empty")),t=e.siblings(".formsteps__error");!1===s.valid?(e.addClass("formsteps__text--error"),t.length?t.text(s.message).removeClass(".formsteps__error--hidden"):(t=$("<p>")).addClass("formsteps__error").text(s.message).insertAfter(e),r=!1):(t.addClass("formsteps__error--hidden"),e.removeClass("formsteps__text--error"))}),!1===r)return!1;ga_step=ga_postfix?"step"+(t.index()+1)+"_"+ga_postfix:"step_"+(t.index()+1),stepTo(t.index()+1);try{ga("send","event",ga_group,"click",ga_step)}catch(e){console.warn("РЎР»РѕРјР°Р»Р°СЃСЊ Р°РЅР°Р»РёС‚РёРєР°",e)}try{yaCounter344978.reachGoal(ga_step)}catch(e){console.warn("РЎР»РѕРјР°Р»Р°СЃСЊ РјРµС‚СЂРёРєР°",e)}}else stepTo(t.index()-1);(t=$(".formsteps__step--current")).is(":first-child")&&s.addClass("formsteps__btn--disabled"),t.find(".formsteps__text--required").length>0&&$(".js-formsteps-btn").last().addClass("formsteps__btn--disabled"),t.is(":last-child")&&showOverlay(),t.index()>0&&$btns.first().removeClass("formsteps__btn--disabled"),t.next().length&&$btns.last().removeClass("formsteps__btn--disabled")}}),$(document).on("keypress",".formsteps__text",function(e){$(".formsteps__step--current").index()!==$(".formsteps__step").length-1&&("13"!=event.keyCode&&"13"!=event.charCode||($(".js-formsteps-btn").last().trigger("click"),$(this).blur()))}),$(document).on("submit",".formsteps__content",function(e){e.preventDefault(),e.stopPropagation();var $formsteps=$(".formsteps"),trigger;try{trigger=$(".formsteps__content").closest(".formsteps-popup").data("trigger")}catch(e){}var $steps=$(".formsteps__step"),valid=!0;if($steps.find(".js-required").each(function(){var e=$(this).find("input"),s=e.siblings(".formsteps__error"),t=validate(e.val(),e.data("type"),e.data("empty"));!1===t.valid&&(e.closest("li").hasClass("formsteps__step--current")&&(e.addClass("formsteps__text--error"),s.length?s.text(t.message).removeClass(".formsteps__error--hidden"):(s=$("<p>")).addClass("formsteps__error").text(t.message).insertAfter(e)),valid=!1)}),!1===valid)return!1;$(this).find("input").each(function(){var e=$(this),s=e.val().slice(0,100);e.val(s)});var data={};$codes=$("[data-code]:checked"),$codes&&$codes.each(function(){var e=".js-"+$(this).data("code");$(e).val($(this).data("value"))});var form=$(this).serializeArray();$.each(form,function(e,s){data[s.name]?data[s.name]=data[s.name]+" "+s.value:data[s.name]=s.value});var url="/my/s3/xapi/public/?method=form/postform&param[form_id]="+$formsteps.data("form_id")+"&param[tpl]="+$formsteps.data("tpl");$.post(url,data).done(function(res){$(".js-final").removeClass("formsteps__final--hidden");var str=$(trigger).data("ga");try{eval(str)}catch(e){console.warn("not valid submit metrics",e)}if("/business-solution-a"==document.location.pathname)try{fbq("track","Lead",{value:10,currency:"USD"})}catch(e){console.warn("something wrong with FB")}})}),$(document).on("focus",".formsteps__text--error",function(){$(this).removeClass("formsteps__text--error")}),$(document).on("change, blur",'.js-required input[type="text"]',function(){$this=$(this),validate($this.val(),$this.data("type"))?($this.removeClass("formsteps__text--error"),$(".js-formsteps-btn").last().removeClass("formsteps__btn--disabled")):$this.addClass("formsteps__text--error")}),$(document).on("click",".formsteps-popup, .formsteps__popup-close",function(e){e.target==this&&$(".formsteps-popup").fadeOut(300).addClass("formsteps-popup--hidden")}),
        $(document).on("keyup",function(e){
            27!=e.keyCode&&27!=e.which||$(".formsteps__popup-close").trigger("click")
        })
});